---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/Nav.astro";
import Footer from "../components/Footer.astro";
import { getCollection } from "astro:content";

const allPosts = await getCollection("writing");

// Extract excerpt from raw markdown content
const posts = allPosts.map((post) => {
  // Get raw markdown body
  const body = post.body;
  
  // Remove markdown syntax and get plain text
  let text = body
    // Remove frontmatter if any
    .replace(/^---[\s\S]*?---\n/, '')
    // Remove markdown headers
    .replace(/^#+\s+/gm, '')
    // Remove markdown links but keep text
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')
    // Remove markdown bold/italic
    .replace(/\*\*([^\*]+)\*\*/g, '$1')
    .replace(/\*([^\*]+)\*/g, '$1')
    // Remove markdown code blocks
    .replace(/```[\s\S]*?```/g, '')
    .replace(/`([^`]+)`/g, '$1')
    // Clean up whitespace
    .replace(/\n+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  
  // Get first 2-3 sentences (approximately 250 characters)
  let excerpt = '';
  if (text.length > 250) {
    const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
    excerpt = sentences.slice(0, 2).join(' ').trim();
    if (excerpt.length < 100 && sentences.length > 2) {
      excerpt = sentences.slice(0, 3).join(' ').trim();
    }
    if (!excerpt.endsWith('.') && !excerpt.endsWith('!') && !excerpt.endsWith('?')) {
      excerpt += '...';
    }
  } else {
    excerpt = text;
  }
  
  return {
    ...post,
    excerpt: excerpt || post.data.summary || 'Read more...'
  };
});

// Sort by date (newest first)
posts.sort((a, b) => 
  new Date(b.data.published).getTime() - new Date(a.data.published).getTime()
);
---
<Layout title="writing — ayushe">
  <Nav />
  <main class="mx-auto max-w-3xl px-6 py-16">
    <h1 class="text-3xl md:text-4xl font-serif mb-6">writing</h1>
    <div class="mb-10">
      <p class="text-gray-700 mb-4">subscribe on substack for new writing.</p>
      <a 
        href="https://ayushenagpal.substack.com/" 
        target="_blank" 
        rel="noopener noreferrer"
        class="inline-block text-blue-600 hover:text-blue-800 underline underline-offset-4"
      >
        → visit my substack
      </a>
    </div>
    <section class="space-y-8">
      {posts.map((post) => (
        <article class="border-b border-gray-200 pb-8 last:border-0">
          <div class="flex items-baseline gap-3 mb-2">
            <time 
              class="text-xs text-gray-500" 
              datetime={post.data.published.toISOString()}
            >
              {new Date(post.data.published).toLocaleDateString(undefined, { 
                year: 'numeric', 
                month: 'short', 
                day: '2-digit' 
              })}
            </time>
            <h2 class="text-xl font-serif">{post.data.title}</h2>
          </div>
          <p class="text-gray-700 mb-3 leading-relaxed">{post.excerpt}</p>
          <a 
            href={`/writing/${post.slug}/`} 
            class="text-blue-600 hover:text-blue-800 underline underline-offset-4 text-sm"
          >
            read more →
          </a>
        </article>
      ))}
    </section>
  </main>
  <Footer />
</Layout>

